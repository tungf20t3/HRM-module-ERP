function hexToBase64(n){return btoa(String.fromCharCode.apply(null,n.replace(/\r|\n/g,"").replace(/([\da-fA-F]{2}) ?/g,"0x$1 ").replace(/ +$/,"").split(" ")))}function hexToPem(n){var t=hexToBase64(n),i=t.match(/.{1,64}/g).join("\n");return"-----BEGIN CERTIFICATE-----\n"+i+"\n-----END CERTIFICATE-----"}var tableStr,table,hwcrypto;window.atob||(tableStr="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/",table=tableStr.split(""),window.atob=function(n){var r;if(/(=[^=]+|={3,})$/.test(n))throw new Error("String contains an invalid character");if(n=n.replace(/=/g,""),r=n.length&3,r===1)throw new Error("String contains an invalid character");for(var e=0,i=0,h=n.length/4,t=[];e<h;++e){var o=tableStr.indexOf(n[i++]||"A"),u=tableStr.indexOf(n[i++]||"A"),f=tableStr.indexOf(n[i++]||"A"),s=tableStr.indexOf(n[i++]||"A");if((o|u|f|s)<0)throw new Error("String contains an invalid character");t[t.length]=(o<<2|u>>4)&255;t[t.length]=(u<<4|f>>2)&255;t[t.length]=(f<<6|s)&255}return String.fromCharCode.apply(null,t).substr(0,t.length+r-4)},window.btoa=function(n){for(var e=0,r=0,o=n.length/3,u=[];e<o;++e){var f=n.charCodeAt(r++),t=n.charCodeAt(r++),i=n.charCodeAt(r++);if((f|t|i)>255)throw new Error("String contains an invalid character");u[u.length]=table[f>>2]+table[f<<4&63|t>>4]+(isNaN(t)?"=":table[t<<2&63|i>>6])+(isNaN(t+i)?"=":table[i&63])}return u.join("")});hwcrypto=function(){"use strict";function c(){return new Promise(function(n,t){var r=function(i){window.parent.removeEventListener("message",r,!1);i.data==="ok"?(console.log("HAS ADDON"),n("ok")):(console.log("REJECT BY BROWSER"),t("undefined"))},i;window.parent.addEventListener("message",r,!1);i=document.createEvent("CustomEvent");i.initCustomEvent("addon_require_message",!0,!0,{type:"TEST"});window.parent.document.dispatchEvent(i);setTimeout(function(){t("undefined")},2e3)})}function p(n){return navigator.mimeTypes&&n in navigator.mimeTypes?!0:!1}function v(n){return typeof top.window[n]=="function"?!0:typeof window[n]=="function"?!0:!1}function l(n){var i,r,t;if(typeof n=="string"){for(i=Math.floor(n.length/2),r=new Uint8Array(i),t=0;t<i;t++)r[t]=parseInt(n.substr(t*2,2),16);return r}}function tt(n){return"hwc"+n.replace("/","").replace("-","")}function it(t){var i=tt(t),u,r;return document.getElementById(i)?(n("Plugin element already loaded"),document.getElementById(i)):(n("Loading plugin for "+t+" into "+i),u='<object id="'+i+'" type="'+t+'" style="width: 1px; height: 1px; position: absolute; visibility: hidden;"><\/object>',r=document.createElement("div"),r.setAttribute("id","pluginLocation"+i),document.body.appendChild(r),document.getElementById("pluginLocation"+i).innerHTML=u,document.getElementById(i))}function rt(){var t="probe() detected ";v(o)&&n(t+o);p(a)&&n(t+a)}function d(){function f(r){n("Error: "+r+" with: "+t.errorMessage);switch(parseInt(r)){case 1:return w;case 2:return i;case 17:return i;case 19:return k;default:return n("Unknown error: "+r+" with: "+t.errorMessage),b}}function r(n){return new Error(f(n))}this._name="NPAPI/BHO for application/x-digidoc";var t=it(a),u={};this.check=function(){return new Promise(function(n){setTimeout(function(){n(typeof t.version!="undefined")},0)})};this.getVersion=function(){return new Promise(function(n){var i=t.version;n(i)})};this.showCertSerial=function(i){return i&&i.lang&&(t.pluginLanguage=i.lang),new Promise(function(i,f){try{var e=t.showCertSerial();parseInt(t.errorCode)!==0?f(r(t.errorCode)):(u[e.cert]=e.id,i({hex:e}))}catch(o){n(o);f(r(t.errorCode))}})};this.selectCertSerial=function(i){return i&&i.lang&&(t.pluginLanguage=i.lang),new Promise(function(i,f){try{var e=t.selectCertSerial();parseInt(t.errorCode)!==0?f(r(t.errorCode)):(u[e.cert]=e.id,i({hex:e}))}catch(o){n(o);f(r(t.errorCode))}})};this.signHashData=function(f,e,o){return new Promise(function(s,h){var c=u[f.hex],l,a;if(c)try{l=o.lang||"en";a=t.signHashData(c,e.hex,l);s({hex:a})}catch(v){n(JSON.stringify(v));h(r(t.errorCode))}else n("invalid certificate: "+f),h(new Error(i))})};this.signXMLData=function(i,u){return new Promise(function(f,e){try{var o=u.lang||"en",s=t.signXMLData(i.value,o);f({hex:s})}catch(h){n(JSON.stringify(h));e(r(t.errorCode))}})}}function y(){this._name="Chrome native messaging extension";var n=null;this.check=function(){return new Promise(function(t){if(!v(o))return t(!1);n=new top.window[o];n?t(!0):t(!1)})};this.getVersion=function(){return n.getVersion()};this.showCertSerial=function(t){return n.showCertSerial(t)};this.selectCertSerial=function(t){return n.selectCertSerial(t)};this.signHashData=function(t,i,r){return n.signHashData(t,i,r)};this.signXMLData=function(t,i){return n.signXMLData(t,i)}}function g(){this._name="No implementation";this.check=function(){return new Promise(function(n){n(!0)})};this.getVersion=function(){return Promise.reject(new Error(r))};this.showCertSerial=function(){return Promise.reject(new Error(r))};this.selectCertSerial=function(){return Promise.reject(new Error(r))};this.signHashData=function(){return Promise.reject(new Error(r))};this.signXMLData=function(){return Promise.reject(new Error(r))}}function f(t){return new Promise(function(i){var r=new t;r.check().then(function(t){t?(n("Using backend: "+r._name),u=r,i(!0)):(n(r._name+" check() failed"),i(!1))})})}function e(t){return new Promise(function(i){function r(){f(d).then(function(n){n?i(!0):i(f(g))})}if(n("Autodetecting best backend"),typeof t=="undefined"&&(t=!1),u!==null&&!t)return i(!0);if(navigator.userAgent.indexOf("MSIE")!=-1||navigator.userAgent.indexOf("Trident")!=-1)return n("Assuming IE BHO, testing"),r();if(navigator.userAgent.indexOf("Chrome")!=-1&&v(o)){f(y).then(function(n){n?i(!0):r()});return}if(navigator.userAgent.indexOf("Firefox")!=-1){f(y).then(function(n){n?i(!0):r()});return}if(p(a))return r();i(f(g))})}var n=function(){},u,t;n("hwcrypto.js activated");var nt=!!window.opera||navigator.userAgent.indexOf(" OPR/")>=0,s=!!window.chrome&&!nt,h=typeof InstallTrigger!="undefined";top.window.addEventListener=top.window.addEventListener||top.window.attachEvent;var a="application/x-digidoc",o="TokenSigningEinvoice",w="user_cancel",i="invalid_argument",b="technical_error",r="no_implementation",k="not_allowed";return top.window.addEventListener("load",function(){rt()}),u=null,t={},t.use=function(n){return new Promise(function(t){typeof n=="undefined"||n==="auto"?e().then(function(n){t(n)}):n==="chrome"?t(f(y)):n==="npapi"?t(f(d)):t(!1)})},t.debug=function(){return new Promise(function(n){var t="hwcrypto.js 0.0.10";e().then(function(){u.getVersion().then(function(i){n(t+" with "+u._name+" "+i)},function(){n(t+" with failing backend "+u._name)})})})},t.showCertSerial=function(t,f){if(typeof f!="object")return n("showSerialCert options parameter must be an object"),Promise.reject(new Error(i));if(f&&!f.lang&&(f.lang="en"),s)return e().then(function(){return u.showCertSerial(t,f).then(function(n){return n.hex&&!n.encoded&&(n.encoded=l(n.hex)),n})});if(h)return new Promise(function(n,i){c().then(function(){var u=document.createEvent("CustomEvent"),r;u.initCustomEvent("addon_require_message",!0,!0,{type:"SHOWCER",cert:t,lang:"en"});window.parent.document.dispatchEvent(u);r=function(t){window.parent.removeEventListener("message",r,!1);var u=JSON.parse(t.data);u.result==="ok"?n({hex:u,value:u}):i(u)};window.parent.addEventListener("message",r,!1)},function(){i(new Error(r))})});reject(new Error("unsupported_browser"))},t.selectCertSerial=function(t){if(typeof t!="object")return n("getSerialCert options parameter must be an object"),Promise.reject(new Error(i));if(t&&!t.lang&&(t.lang="en"),s)return e().then(function(){return u.selectCertSerial(t).then(function(n){return n.hex&&!n.encoded&&(n.encoded=l(n.hex)),n})});if(h)return new Promise(function(n,i){c().then(function(){var u=document.createEvent("CustomEvent"),r;u.initCustomEvent("addon_require_message",!0,!0,{type:"SERIAL_CERT",lang:t.lang});window.parent.document.dispatchEvent(u);r=function(t){window.parent.removeEventListener("message",r,!1);var u=JSON.parse(t.data);u.result==="ok"?n({hex:u,value:u}):i(u)};window.parent.addEventListener("message",r,!1)},function(){i(new Error(r))})});reject(new Error("unsupported_browser"))},t.signXMLData=function(n,t){if(arguments.length<2||(t&&!t.lang&&(t.lang="en"),!n.type||!n.value&&!n.hex))return Promise.reject(new Error(i));if(n.hex&&!n.value&&(n.value=n.hex),n.value&&!n.hex&&(n.hex=n.value),s)return e().then(function(){return u.signXMLData(n,t).then(function(n){return n.hex&&!n.value&&(n.value=l(n.hex)),n})});if(h)return new Promise(function(t,i){c().then(function(){var u=window.parent.document.createEvent("CustomEvent"),r;u.initCustomEvent("addon_require_message",!0,!0,{type:"SIGN",lang:"en",cert:"",hash:n});window.parent.document.dispatchEvent(u);r=function(n){window.parent.removeEventListener("message",r,!1);var u=JSON.parse(n.data);u.result==="ok"?t({hex:u,value:u}):i(u)};window.parent.addEventListener("message",r,!1)},function(){i(new Error(r))})});reject(new Error("unsupported_browser"))},t.signHashData=function(n,t,f){if(arguments.length<2||(f&&!f.lang&&(f.lang="en"),!t.type||!t.value&&!t.hex))return Promise.reject(new Error(i));if(t.hex&&!t.value&&(t.value=t.hex),t.value&&!t.hex&&(t.hex=t.value),s)return new Promise(function(i){setTimeout(function(){i(e().then(function(){return u.signHashData(n,t,f).then(function(n){return n.hex&&!n.value&&(n.value=l(n.hex)),n})}))},700)});if(h)return new Promise(function(i,u){c().then(function(){var f=window.parent.document.createEvent("CustomEvent"),r;f.initCustomEvent("addon_require_message",!0,!0,{type:"SIGN",lang:"en",cert:n,hash:t});window.parent.document.dispatchEvent(f);r=function(n){window.parent.removeEventListener("message",r,!1);var t=JSON.parse(n.data);t.result==="ok"?i({hex:t,value:t}):u(t)};window.parent.addEventListener("message",r,!1)},function(){u(new Error(r))})});reject(new Error("unsupported_browser"))},t.NO_IMPLEMENTATION=r,t.USER_CANCEL=w,t.NOT_ALLOWED=k,t.NO_CERTIFICATES="no_certificates",t.TECHNICAL_ERROR=b,t.INVALID_ARGUMENT=i,t}()