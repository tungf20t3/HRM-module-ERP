<?xml version="1.0" encoding="utf-8"?>

<!DOCTYPE initialize [
  <!ENTITY % Invoice SYSTEM "..\..\Include\Invoice.ent">
  %Invoice;

  <!ENTITY % Control.Unit SYSTEM "..\..\Include\Unit.ent">
  %Control.Unit;
  %Control.Unit.Include.Product;
  %Control.Unit.Ignore;
]>

<initialize xmlns="urn:schemas-ai-erp:dir-initialize">
  <controllers>
    <controller name="GSTran" group="Aggregation.Voucher"/>
    <controller name="GLTran" group="Aggregation.Voucher"/>

    <controller name="JRTran" group="Aggregation.Voucher"/>
    <controller name="JPTran" group="Aggregation.Voucher"/>

    <controller name="GCTran" group="Aggregation.Voucher"/>

    <controller name="CBTran" group="Aggregation.Voucher"/>
    <controller name="CPTran" group="Aggregation.Voucher"/>
    <controller name="CRTran" group="Aggregation.Voucher"/>
    <controller name="CDTran" group="Aggregation.Voucher"/>
    <controller name="CITran" group="Aggregation.Voucher"/>
    <controller name="CKTran" group="Aggregation.Voucher"/>

    <controller name="DCTran" group="Aggregation.Voucher"/>
    <controller name="DTTran" group="Aggregation.Voucher"/>

    <controller name="SVTran" group="Invoice"/>
    <controller name="ARTran" group="Invoice"/>
    <controller name="SPTran" group="Invoice"/>
    <controller name="SDTran" group="Invoice"/>
    <controller name="VATran" group="Invoice"/>

    <controller name="GRTran" group="Aggregation.Voucher"/>
    <controller name="SRTran" group="Aggregation.Voucher"/>

    <controller name="RDTran" group="Allocation"/>
    <controller name="DDTran" group="Allocation"/>

    <controller name="WRTran" group="Voucher"/>
    <controller name="WPTran" group="Voucher"/>

    <controller name="AITran" group="Invoice"/>
    <controller name="AdjustmentIssueTran" group="Invoice"/>

    <controller name="RITran" group="Invoice"/>

    <controller name="PVTran" group="Aggregation.Voucher"/>
    <controller name="PMTran" group="Aggregation.Voucher"/>
    <controller name="APTran" group="Aggregation.Voucher"/>

    <controller name="PGTran" group="Aggregation.Voucher"/>

    <controller name="PFTran" group="Aggregation.Voucher"/>

    <controller name="ASTran" group="Aggregation.Voucher"/>

    <controller name="PATran" group="Aggregation.Voucher"/>
    <controller name="PSTran" group="Invoice"/>
    <controller name="PXTran" group="Invoice"/>

    <controller name="SQTran" group="Aggregation.Voucher"/>
    <controller name="SOTran" group="Aggregation.Voucher"/>

    <controller name="SITran" group="Voucher"/>
    <controller name="SI2Tran" group="Voucher"/>
    <controller name="STTran" group="Voucher"/>

    <controller name="S1Tran" group="Aggregation.Voucher"/>
    <controller name="S2Tran" group="Aggregation.Voucher"/>
    <controller name="S5Tran" group="Aggregation.Voucher"/>
    <controller name="S6Tran" group="Voucher"/>
    <controller name="S7Tran" group="Voucher"/>
    <controller name="S8Tran" group="Voucher"/>
    <controller name="SFCOperationTransfer" group="Voucher"/>

    <controller name="PRTran" group="Aggregation.Voucher"/>
    <controller name="PQTran" group="Voucher"/>
    <controller name="POTran" group="Aggregation.Voucher"/>

    <controller name="PITran" group="Aggregation.Voucher"/>
    <controller name="PKTran" group="Aggregation.Voucher"/>

    <controller name="PDTran" group="Aggregation.Voucher"/>
    <controller name="PTTran" group="Voucher"/>

    <controller name="PV0Tran" group="Aggregation.Voucher"/>

    <controller name="IRTran" group="Aggregation.Voucher"/>
    <controller name="MRTran" group="Aggregation.Voucher"/>
    <controller name="ISTran" group="Invoice"/>
    <controller name="ITTran" group="Invoice"/>
    <controller name="IPTran" group="Aggregation.Voucher"/>

    <controller name="WHTran" group="Aggregation.Voucher"/>
    <controller name="WITran" group="Aggregation.Voucher"/>
    <controller name="WTTran" group="Aggregation.Voucher"/>
    <controller name="WKTran" group="Aggregation.Voucher"/>
    <controller name="WSTran" group="Aggregation.Voucher"/>
    <controller name="WQTran" group="Aggregation.Voucher"/>

    <controller name="MOTran" group="Voucher"/>
    <controller name="BMTran" group="Product"/>

    <controller name="FATran" group="Aggregation.Voucher"/>
    <controller name="TSTran" group="Aggregation.Voucher"/>

    <controller name="TS2Tran" group="Aggregation.Voucher"/>

    <controller name="hrTSRequisition" group="Voucher"/>

    <controller name="hrEmployeeProductQuantityInput" group="Department"/>
    <controller name="hrDepartmentProductQuantityInput" group="Department"/>
    <controller name="hrSalaryAdvance" group="Department"/>

    <controller name="SATran" group="Other"/>
    <controller name="HDCTran" group="Other"/>
    <controller name="HDTran" group="Other"/>
    <controller name="T1Tran" group="Aggregation.Other"/>
    <controller name="T2Tran" group="Aggregation.Other"/>

    <controller name="hrProgressiveTaxTariff" group="Aggregation.Other"/>
    <controller name="hrFlatRateTariff" group="Aggregation.Other"/>
    <controller name="hrTMCourseInformation" group="Other"/>
    <controller name="hrRMRequest" group="Other"/>
    <controller name="hrTMRequest" group="Other"/>
    <controller name="hrTMCourseResult" group="Other"/>
    <controller name="hrTSDecrease" group="Other"/>
    <controller name="hrTSIssue" group="Other"/>
    <controller name="hrWrittenRequest" group="Other"/>
    <controller name="hrRMPeriodInfoInput" group="Other"/>

    <controller name="hrPIGeneralInformation" group="External"/>
    <controller name="hrEmployeeShiftSchedule" group="External"/>
    <controller name="hrEmployeeShiftScheduleByDay" group="External"/>

    <controller name="hrEmployeeCardInfoInput" group="External"/>
    <controller name="hrEmployeeInsuranceAndUnionDueInformation" group="External"/>
    <controller name="hrEmployeePITInformation" group="External"/>
    <controller name="hrEmployeeSalaryInformation" group="External"/>

    <controller name="PhysicalCountQtyUpdate" group="Aggregation.External"/>
    <controller name="hrEmployeeTimekeepingImport" group="External"/>

    <controller name="DTApproval" group="Aggregation.Approval"/>
    <controller name="DCApproval" group="Aggregation.Approval"/>
    <controller name="CPApproval" group="Aggregation.Approval"/>
    <controller name="SOApproval" group="Aggregation.Approval"/>
    <controller name="PRApproval" group="Aggregation.Approval"/>
    <controller name="POApproval" group="Aggregation.Approval"/>
    <controller name="MRApproval" group="Aggregation.Approval"/>
    <controller name="hrTMApproval" group="Approval"/>
    <controller name="hrRMApproval" group="Approval"/>
    <controller name="hrTSRequisitionApproval" group="Approval"/>

    <controller name="S2Approval" group="Aggregation.Approval"/>
    <controller name="S2Close" group="Aggregation.Approval"/>

    <controller name="DTClose" group="Aggregation.Close"/>
    <controller name="DCClose" group="Aggregation.Close"/>
    <controller name="SOClose" group="Aggregation.Close"/>
    <controller name="PRClose" group="Aggregation.Voucher"/>
    <controller name="POClose" group="Aggregation.Voucher"/>
    <controller name="MRClose" group="Aggregation.Close"/>
    <controller name="TRClose" group="Close"/>
    <controller name="RRClose" group="Close"/>
    <controller name="hrTSRequisitionClose" group="Close"/>

    <controller name="SOAuthorize" group="Authorize"/>
    <controller name="PaymentAdjustments" group="Authorize"/>
    <controller name="EBankingAdjustments" group="Authorize"/>

    <controller name="CRBillResource" group="External"/>
    <controller name="CRRoutingMaintenance" group="External"/>

    <controller name="rptPrintGLTran" group="Aggregation.Voucher"/>
    <controller name="rptPrintCBTran" group="Aggregation.Voucher"/>
    <controller name="rptPrintCRTran" group="Aggregation.Voucher"/>

    <controller name="rptPrintCPTran" group="Aggregation.Voucher"/>
    <controller name="rptPrintCDTran" group="Aggregation.Voucher"/>

    <controller name="rptPrintPVTran" group="Aggregation.Voucher"/>
    <controller name="rptPrintIRTran" group="Aggregation.Voucher"/>

    <controller name="rptPrintARTran" group="Print.Invoice"/>
    <controller name="rptPrintISTran" group="Print.Invoice"/>
    <controller name="rptPrintSVTran" group="Print.Invoice"/>
    <controller name="rptPrintITTran" group="Print.Invoice"/>

    <controller name="rptPrintPMTran" group="Aggregation.Voucher"/>
    <controller name="rptPrintAPTran" group="Aggregation.Voucher"/>

    <controller name="rptPrintPGTran" group="Aggregation.Voucher"/>
    <controller name="rptPrintPFTran" group="Aggregation.Voucher"/>
    <controller name="rptPrintIPTran" group="Aggregation.Voucher"/>

    <controller name="rptPrintBMTran" group="Product"/>





    <controller name="BISLTran" group="External"/>
    <controller name="BIQATran" group="External"/>

    <controller name="BIPQTran" group="Aggregation.Voucher"/>

    <controller name="BIOATran" group="Aggregation.Voucher"/>
    <controller name="BISATran" group="Aggregation.Voucher"/>

    <controller name="BIPOTran" group="Aggregation.Voucher"/>
    <controller name="BIPITran" group="Aggregation.Voucher"/>

    <controller name="PQApproval" group="Aggregation.Approval"/>
    <controller name="PQClose" group="Aggregation.Close"/>

    <controller name="BIOAApproval" group="Aggregation.Approval"/>
    <controller name="BIOAClose" group="Aggregation.Close"/>

    <controller name="BISAClose" group="Aggregation.Close"/>
    <controller name="BISAApproval" group="Aggregation.Approval"/>

    <controller name="BIMaintainPurOrgData" group="External"/>

    <controller name="BIScoreByItem" group="External"/>
    <controller name="BIScoreEvaluationPeriod" group="External"/>
    <controller name="BIVendorEvaluationAdjustment" group="External"/>


    <controller name="BIInspectionPlan" group="External"/>

    <controller name="BIILTran" group="Aggregation.Voucher"/>
    <controller name="BIILApproval" group="Aggregation.Approval"/>
    <controller name="BIILClose" group="Aggregation.Close"/>

    <controller name="BIUDTran" group="Voucher"/>

    <controller name="BIResultRecording" group="External"/>





    <controller name="hrTaxDeduction" group="Aggregation.Close"/>

    <controller name="InputInvoice" group="Aggregation.Voucher"/>
    <controller name="InputInvoiceTaxError" group="External"/>
  </controllers>

  <groups>
    <group id="Voucher">
      <flag reference="so_ct1" width="128">
        <field name="s6" type="Int16" defaultValue="0" filterSource="Vacant">
          <header v="" e=""/>
          <query>
            <![CDATA[if @s6 = 1 insert into #_f(datasource, type, filterkey) select @@prime + case when @@expression = '''''' then '' else '%Partition' end, 1, '%[a].s6 = ' + rtrim(cast(@s6 as int))]]>
          </query>
        </field>

        <query>
          <apppend>
            <text>
              <![CDATA[
, default, default, default, default, default, default, @$primeAlias, @$primeJoin, @$primeFilter, @$detailPartition, @$detailAlias, @$detailFilter
]]>
            </text>
          </apppend>
        </query>
      </flag>
    </group>

    <group id="Invoice">
      <flag reference="so_ct1" width="128">
        <field name="s6" type="Int16" defaultValue="0" filterSource="Vacant">
          <header v="" e=""/>
          <query>
            <![CDATA[if @s6 = 1 insert into #_f(datasource, type, filterkey) select @@prime + case when @@expression = '''''' then '' else '%Partition' end, 1, '%[a].s6 = ' + rtrim(cast(@s6 as int))]]>
          </query>
        </field>

        <query>
          <apppend>
            <text>
              &QueryDefault;&QueryDefault;&QueryDefault;&QueryDefault;&QueryDefault;&QueryDefault;
              <![CDATA[
, @$primeAlias, @$primeJoin, @$primeFilter, @$detailPartition, @$detailAlias, @$detailFilter, @$aggregationAlias, @@aggregation
]]>
            </text>
          </apppend>
        </query>
      </flag>
    </group>

    <group id="Allocation">
      <flag reference="so_ct1" width="128">
        <field name="s6" type="Int16" defaultValue="0" filterSource="Vacant">
          <header v="" e=""/>
          <query>
            <![CDATA[if @s6 = 1 insert into #_f(datasource, type, filterkey) select @@prime + '%Partition', 1, '%[a].s6 = ' + rtrim(cast(@s6 as int))]]>
          </query>
        </field>

        <query>
          <apppend>
            <text>
              <![CDATA[
, default, default, default, @$primeAlias, @$primeJoin, @$primeFilter, @$detailPartition, @$detailAlias, @$detailFilter
]]>
            </text>
          </apppend>
        </query>
      </flag>
    </group>

    <group id="Product">
      <flag reference="ma_sp" width="128">
        <field name="s6" type="Int16" defaultValue="0" filterSource="Vacant">
          <header v="" e=""/>
          <query>
            <![CDATA[if @s6 = 1 insert into #_f(datasource, type, filterkey) select @@prime, 2, '%[a].s6 = ' + rtrim(cast(@s6 as int))]]>
          </query>
        </field>

        <query>
          <apppend>
            <text>
              <![CDATA[
, @$primeAlias, @$primeJoin, @$primeFilter, @$detailPartition, @$detailAlias, @$detailFilter
]]>
            </text>
          </apppend>
        </query>
      </flag>
    </group>

    <group id="External">
      <flag width="128">
        <field name="" type="Int16" defaultValue="0" filterSource="Vacant">
          <header v="" e=""/>
          <query>
          </query>
        </field>

        <query>
          <apppend>
            <text>
              <![CDATA[
, @$primeAlias, @$primeJoin, @$primeFilter, @$detailPartition, @$detailAlias, @$detailFilter
]]>
            </text>
          </apppend>
        </query>
      </flag>
    </group>

    <group id="Approval">
      <flag width="128">
        <field name="" type="Int16" defaultValue="0" filterSource="Vacant">
          <header v="" e=""/>
          <query>
          </query>
        </field>

        <query>
          <apppend>
            <text>
              <![CDATA[
, @$detailPartition, @$detailAlias, @$detailFilter
if object_id('tempdb..#a') is not null drop table #a
]]>
            </text>
          </apppend>
        </query>
      </flag>
    </group>

    <group id="Close">
      <flag width="128">
        <field name="" type="Int16" defaultValue="0" filterSource="Vacant">
          <header v="" e=""/>
          <query>
          </query>
        </field>

        <query>
          <apppend>
            <text>
              <![CDATA[
, @$detailPartition, @$detailAlias, @$detailFilter
]]>
            </text>
          </apppend>
        </query>
      </flag>
    </group>

    <group id="Authorize">
      <flag width="128">
        <field name="" type="Int16" defaultValue="0" filterSource="Vacant">
          <header v="" e=""/>
          <query>
          </query>
        </field>

        <query>
          <apppend>
            <text>
              <![CDATA[
]]>
            </text>
          </apppend>
        </query>
      </flag>
    </group>

    <group id="Department">
      <flag width="128">
        <field name="s6" type="Int16" defaultValue="0" filterSource="Vacant">
          <header v="" e=""/>
          <query>
            <![CDATA[if @s6 = 1 insert into #_f(datasource, type, filterkey) select @@prime + '%Partition', 1, '%[a].s6 = ' + rtrim(cast(@s6 as int))]]>
          </query>
        </field>

        <query>
          <apppend>
            <text>
              <![CDATA[
, default, default, @$rightKey, default, default, default, @$primeAlias, @$primeJoin, @$primeFilter, @$detailPartition, @$detailAlias, @$detailFilter
]]>
            </text>
          </apppend>
        </query>
      </flag>
    </group>

    <group id="Other">
      <flag width="128">
        <field name="s6" type="Int16" defaultValue="0" filterSource="Vacant">
          <header v="" e=""/>
          <query>
            <![CDATA[if @s6 = 1 insert into #_f(datasource, type, filterkey) select @@prime + '%Partition', 1, '%[a].s6 = ' + rtrim(cast(@s6 as int))]]>
          </query>
        </field>

        <query>
          <apppend>
            <text>
              <![CDATA[
, default, default, default, default, default, default, @$primeAlias, @$primeJoin, @$primeFilter, @$detailPartition, @$detailAlias, @$detailFilter
]]>
            </text>
          </apppend>
        </query>
      </flag>
    </group>

    <group id="Print.Invoice">
      <flag reference="so_ct1" width="128">
        <field name="s6" type="Int16" defaultValue="0" filterSource="Vacant">
          <header v="" e=""/>
          <query>
            <![CDATA[if @s6 = 1 insert into #_f(datasource, type, filterkey) select @@prime + case when @@expression = '''''' then '' else '%Partition' end, 1, '%[a].s6 = ' + rtrim(cast(@s6 as int))]]>
          </query>
        </field>

        <query>
          <apppend>
            <text>
              <![CDATA[
, @$primeAlias, @$primeJoin, @$primeFilter, @$detailPartition, @$detailAlias, @$detailFilter, @$aggregationAlias, @@aggregation
]]>
            </text>
          </apppend>
        </query>
      </flag>
    </group>

    <group id="Aggregation.Voucher">
      <flag reference="so_ct1" width="128">
        <field name="s6" type="Int16" defaultValue="0" filterSource="Vacant">
          <header v="" e=""/>
          <query>
            <![CDATA[if @s6 = 1 insert into #_f(datasource, type, filterkey) select @@prime + case when @@expression = '''''' then '' else '%Partition' end, 1, '%[a].s6 = ' + rtrim(cast(@s6 as int))]]>
          </query>
        </field>

        <query>
          <apppend>
            <text>
              <![CDATA[
, default, default, default, default, default, default, @$primeAlias, @$primeJoin, @$primeFilter, @$detailPartition, @$detailAlias, @$detailFilter, @$aggregationAlias, @@aggregation
]]>
            </text>
          </apppend>
        </query>
      </flag>
    </group>

    <group id="Aggregation.External">
      <flag width="128">
        <field name="" type="Int16" defaultValue="0" filterSource="Vacant">
          <header v="" e=""/>
          <query>
          </query>
        </field>

        <query>
          <apppend>
            <text>
              <![CDATA[
, @$primeAlias, @$primeJoin, @$primeFilter, @$detailPartition, @$detailAlias, @$detailFilter, @@aggregation
]]>
            </text>
          </apppend>
        </query>
      </flag>
    </group>

    <group id="Aggregation.Approval">
      <flag width="128">
        <field name="" type="Int16" defaultValue="0" filterSource="Vacant">
          <header v="" e=""/>
          <query>
          </query>
        </field>

        <query>
          <apppend>
            <text>
              <![CDATA[
, @$detailPartition, @$detailAlias, @$detailFilter, 'b', @@aggregation
if object_id('tempdb..#a') is not null drop table #a
]]>
            </text>
          </apppend>
        </query>
      </flag>
    </group>

    <group id="Aggregation.Close">
      <flag width="128">
        <field name="" type="Int16" defaultValue="0" filterSource="Vacant">
          <header v="" e=""/>
          <query>
          </query>
        </field>

        <query>
          <apppend>
            <text>
              <![CDATA[
]]>
            </text>
          </apppend>
        </query>
      </flag>
    </group>

    <group id="Aggregation.Other">
      <flag width="128">
        <field name="s6" type="Int16" defaultValue="0" filterSource="Vacant">
          <header v="" e=""/>
          <query>
            <![CDATA[if @s6 = 1 insert into #_f(datasource, type, filterkey) select @@prime + '%Partition', 1, '%[a].s6 = ' + rtrim(cast(@s6 as int))]]>
          </query>
        </field>

        <query>
          <apppend>
            <text>
              <![CDATA[
, default, default, default, default, default, default, @$primeAlias, @$primeJoin, @$primeFilter, @$detailPartition, @$detailAlias, @$detailFilter, @$aggregationAlias, @@aggregation
]]>
            </text>
          </apppend>
        </query>
      </flag>
    </group>
  </groups>

  <query>
    <insert>
      <text>
        <![CDATA[
declare @$primeAlias varchar(32), @$primeJoin varchar(4000), @$primeFilter nvarchar(4000), @$detailPartition varchar(4000), @$detailAlias varchar(4000), @$detailFilter nvarchar(4000), @$aggregationAlias varchar(32)
create table #_f(i int identity(1, 1), datasource varchar(32), type tinyint, filterkey nvarchar(4000), alias varchar(32), xtype tinyint, refKey varchar(128), exRefKey varchar(128), refdatasource varchar(32), refalias varchar(32), fieldKey varchar(128), joinClause varchar(512))
select @$primeAlias = '', @$primeJoin = '', @$primeFilter = '', @$detailPartition = '', @$detailAlias = '', @$detailFilter = '', @$aggregationAlias = ''
]]>
      </text>
    </insert>

    <apppend>
      <text>
        <![CDATA[
if object_id('tempdb..#filter') is not null begin
  insert into #_f(datasource, type, filterkey, xtype, refKey, exRefKey, refdatasource, fieldKey, joinClause)
    select isnull(b.xtable, ''), '1', replace(case when b.conditionalreplace is null then a.conditional else replace(a.conditional, char(255) + a.field, replace(replace(b.conditionalreplace, b.name, a.field), '%2', '%l')) end, char(255) + a.field, case when charindex(char(254), isnull(b.exname, '')) > 0 then '' else '%[a].' end + isnull(replace(replace(b.exname, '%2', '%l'), char(254), ''), a.field)), case when b.conditionalreplace is null then a.type else 0 end, b.fieldkey, b.exfieldkey, b.reftable, b.reffieldkey, isnull(b.joinclause, '')
      from #filter a join @@sysDatabaseName..sysfilterdeclares b on b.controller = @@controller and a.field = replace(b.name, '%2', '%l')
end

-- Special
-- Begin
if @@id in ('DM1', 'CR1') begin
  select @$primeAlias = '']]>&Conditional.Control.Unit.Product.Alias;<![CDATA[
  ]]>&Conditional.Control.Unit.Product.FilterQuery;<![CDATA[
  if ]]>&Conditional.Control.Unit.Product.Conditional;<![CDATA[ insert into #_f(datasource, type, filterkey, xtype, refKey, exRefKey, refdatasource, fieldKey, joinClause) select ']]>&Conditional.Control.Unit.Product.DataSource;<![CDATA[', 1, ]]>&Conditional.Control.Unit.Product.FilterKey;<![CDATA[, 0, 'ma_vt', 'ma_vt', '%inquiryTable', 'ma_vt', 'a.ma_sp = b.ma_vt'
end
-- End

if exists(select 1 from #_f) exec AI_ERP$System$GetDynamicFilter @@userID, @@admin, @$primeAlias output, @$primeJoin output, @$primeFilter output, @$detailPartition output, @$detailAlias output, @$detailFilter output, @@prime, @$aggregationAlias output
]]>
      </text>
    </apppend>
  </query>
</initialize>