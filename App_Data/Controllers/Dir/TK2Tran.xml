<?xml version="1.0" encoding="utf-8"?>

<!DOCTYPE dir [
  <!ENTITY XMLWhenVoucherInit SYSTEM "..\Include\XML\WhenVoucherInit.xml">
  <!ENTITY XMLWhenVoucherNavigating SYSTEM "..\Include\XML\WhenVoucherNavigating.xml">
  <!ENTITY XMLWhenVoucherClosing SYSTEM "..\Include\XML\WhenVoucherClosing.xml">
  <!ENTITY XMLGetVoucherNumber SYSTEM "..\Include\XML\GetVoucherNumber.xml">
  <!ENTITY XMLGetContactInfo SYSTEM "..\Include\XML\GetContactInfo.xml">
  <!ENTITY XMLVoucherBookAndNumberFields SYSTEM "..\Include\XML\VoucherBookAndNumberFields.txt">
  <!ENTITY CommandWhenVoucherLoading SYSTEM "..\Include\Command\WhenVoucherLoading.txt">
  <!ENTITY CommandWhenVoucherBeforeEdit SYSTEM "..\Include\Command\WhenVoucherBeforeEdit.txt">
  <!ENTITY CommandWhenVoucherBeforeDelete SYSTEM "..\Include\Command\WhenVoucherBeforeDelete.txt">
  <!ENTITY CommandRecordHasBeenChanged SYSTEM "..\Include\Command\RecordHasBeenChanged.txt">
  <!ENTITY CommandCheckVoucherHandleBeforeSave SYSTEM "..\Include\Command\CheckVoucherHandleBeforeSave.txt">
  <!ENTITY CommandCheckVoucherHandleBeforeEdit SYSTEM "..\Include\Command\CheckVoucherHandleBeforeEdit.txt">
  <!ENTITY CommandCheckVoucherHandleBeforeDelete SYSTEM "..\Include\Command\CheckVoucherHandleBeforeDelete.txt">
  <!ENTITY CommandCheckLockedDate SYSTEM "..\Include\Command\CheckClosingDate.txt">
  <!ENTITY CommandGetIdentityNumber SYSTEM "..\Include\Command\GetIdentityNumber.txt">
  <!ENTITY CommandGetVoucherNumber SYSTEM "..\Include\Command\GetVoucherNumber.txt">
  <!ENTITY CommandSetVoucherNumber SYSTEM "..\Include\Command\SetVoucherNumber.txt">
  <!ENTITY CommandQueryVoucherNumber SYSTEM "..\Include\Command\QueryVoucherNumber.txt">
  <!ENTITY CommandScatterVoucherNumber SYSTEM "..\Include\Command\ScatterVoucherNumber.txt">
  <!ENTITY ScriptVoucherInit SYSTEM "..\Include\Javascript\VoucherInit.txt">
  <!ENTITY ScriptVoucherNumber SYSTEM "..\Include\Javascript\VoucherNumber.txt">
  <!ENTITY VoucherNumberLoading SYSTEM "..\Include\Javascript\WhenVoucherNumberLoading.txt">
  <!ENTITY VoucherNumberScattering SYSTEM "..\Include\Javascript\WhenVoucherNumberScattering.txt">
  <!ENTITY VoucherNumberReading SYSTEM "..\Include\Javascript\WhenVoucherNumberReading.txt">

  <!ENTITY % VoucherEndUpdated SYSTEM "..\Include\VoucherEndUpdated.ent">
  %VoucherEndUpdated;

  <!ENTITY AI_ERP.Encryption.Begin "">
  <!ENTITY AfterUpdate "
exec AI_ERP$App$Voucher$UpdateInquiryTable @@id, '@@inquiry$partition$current', '@@prime$partition$current', 'dtk2$$partition$current', 'stt_rec', @stt_rec, @@operation
exec AI_ERP$App$Voucher$UpdateGrandTable @@id, '@@master', '@@prime$partition$current', 'stt_rec', @stt_rec, 1, &HandleVoucherNumberUpdateGrandTable;
UPDATE ctk2$000000 set ma_kh = @ma_kh, ma_vv = @ma_vv, so_gpsd = @so_gpsd, ngay_hsd1 = @ngay_hsd1, ngay_hsd2 = @ngay_hsd2,ngay_ky = @ngay_ky, dien_giai = @dien_giai where stt_rec = @stt_rec
exec AI_ERP$App$Voucher$UpdateGeneral @@id, 'mtk2$$partition$current', 'dtk2$$partition$current', '@@inquiry$partition$current', '@@prime$partition$current', @stt_rec">
  <!ENTITY AI_ERP.Encryption.End "">

  <!ENTITY % VoucherDeleteLog SYSTEM "..\Include\VoucherDeleteLog.ent">
  %VoucherDeleteLog;

  <!ENTITY % Extender SYSTEM "..\Include\Extender.ent">
  %Extender;
  %Extender.Include.TK2Tran;
  %Extender.Ignore;

  <!ENTITY % VoucherEditLog SYSTEM "..\Include\VoucherEditLog.ent">
  %VoucherEditLog;

  <!ENTITY % HandleVoucherNumber SYSTEM "..\Include\HandleVoucherNumber.ent">
  %HandleVoucherNumber;
  <!ENTITY % HandleVoucherNumber.Definition SYSTEM "..\Include\HandleVoucherNumber.001">
  %HandleVoucherNumber.Definition;
  <!ENTITY CheckSoGPInserting "
	if exists(select 1 from @@master where rtrim(ma_dvcs) = rtrim(@ma_dvcs) and rtrim(so_gpsd) = rtrim(@so_gpsd) and rtrim(ma_kh) = rtrim(@ma_kh) and status &lt;&gt; '*' ) begin
		 select N'Số Giấy phép cho khách hàng này đã tồn tại ở đơn vị hiện hành.' as message
		 return
	end
">
  <!ENTITY CheckSoGPUpdating "
	if exists(select 1 from @@master where stt_rec &lt;&gt; @stt_rec and ma_dvcs = @ma_dvcs and so_gpsd = @so_gpsd and ma_kh = @ma_kh and status &lt;&gt; '*' ) begin
		 select N'Số Giấy phép cho khách hàng này đã tồn tại ở đơn vị hiện hành.' as message
		 return
	end
">
  <!ENTITY % Revert SYSTEM "..\Include\Revert.TK2Tran.ent">
  %Revert;
]>

<dir table="mtk2$000000" code="stt_rec" order="ngay_ct, so_ct" id="HCE" type="Voucher" uniKey="true" replication="1" navigation="true" name="cookie" check="true" xmlns="urn:schemas-ai-erp:data-dir">
  <title v="thiết kế cơ sở nổ mìn" e="Blasting Facility Design"></title>
  <partition table="ctk2$000000" prime="mtk2$" inquiry="itk2$" field="ngay_ct" expression="convert(char(6), {0}, 112)" increase="dateadd(month, 1, {0})" default="000000"/>
  <fields>
    <field name="stt_rec" isPrimaryKey="true" readOnly="true" hidden="true">
      <header v="" e=""></header>
    </field>
    <field name="ma_dvcs" hidden="true" readOnly="true">
      <header v="" e=""></header>
    </field>
    <field name="so_gpsd" allowNulls="false">
      <header v="Số thiết kế cơ sở" e="Basic design number"></header>
    </field>

    <field name="ma_kh" allowNulls="false" allowContain="true">
      <header v="Mã Cty" e="Customer"></header>
      <items style="AutoComplete" controller="Customer" reference="ten_kh%l" key="(kh_yn = 1 or nv_yn = 1) and status = '1'" check="kh_yn = 1 or nv_yn = 1" information="ma_kh$dmkh.ten_kh%l"/>
      <clientScript><![CDATA[onchange="onChange$Voucher$Customer(this);"]]></clientScript>
    </field>
    <field name="ten_kh%l" readOnly="true" external="true" defaultValue="''">
      <header v="" e=""></header>
    </field>
    <field name="dien_giai" clientDefault="Thiết kế cơ sở" >
      <header v="Trích yếu" e="Memo"></header>
    </field>
    <field name="ma_vv" allowNulls="false" >
      <header v="Mã công trình" e="Customer"></header>
      <items style="AutoComplete" controller="zcdmvv" reference="ten_vv%l" key="status = '1' and ma_kh = '{$%c[ma_kh]}' and ma_dvcs in (select ma_dvcs from dmdvcs where @@admin = 1 or ma_dvcs in (select ma_dvcs from sysunitrights where user_id = @@userID) and status = '1')" check="status = '1'" information="ma_vv$zcdmvv.ten_vv%l"/>
    </field>
    <field name="ten_vv%l" readOnly="true" external="true" defaultValue="''">
      <header v="" e=""></header>
    </field>
    <field name="ngay_ky" type="DateTime" dataFormatString="@datetimeFormat" clientDefault="Default" allowNulls="false">
      <header v="Ngày ký" e=""></header>
      <clientScript><![CDATA[onchange="onChange$Voucher$Ngay_ky(this);"]]></clientScript>
    </field>

    <field name="fcode3">
      <header v="Gia hạn cho" e="Customer"></header>
      <items style="AutoComplete" controller="zcgptkcs" reference="ten_fcode3%l" key="status &lt;&gt; '*' and ma_kh = '{$%c[ma_kh]}'" check="status &lt;&gt; '*'" information="so_gpsd$ctk2$000000.stt_rec"/>
    </field>
    <field name="stt_rec" readOnly="true" external="true" defaultValue="''" hidden="true">
      <header v="" e=""></header>
    </field>

    <field name="so_thang" dataFormatString="### ##0" clientDefault="0" type="Decimal">
      <header v="Hạn thiết kế cơ sở" e="Basic design deadline"></header>
      <clientScript><![CDATA[onchange="onChange$Voucher$Ngay_ky1(this);"]]></clientScript>
      <items style="Numeric"/>
    </field>

    <field name="ngay_hsd1" type="DateTime" dataFormatString="@datetimeFormat" clientDefault="Default" allowNulls="false">
      <header v="Từ ngày" e=""></header>
      <clientScript><![CDATA[onchange="onChange$Voucher$Ngay_ky1(this);"]]></clientScript>
    </field>
    <field name="ngay_hsd2" type="DateTime" dataFormatString="@datetimeFormat" clientDefault="Default" allowNulls="false">
      <header v="Đến ngày" e=""></header>
    </field>

    <field name="ub_nd" >
      <header v="Cơ quan chức năng phê duyệt" e="Authorized agency approval"></header>
      <items style="AutoComplete" controller="zcdmcqcnpd" reference="ten_noi_cap%l" key="status = '1'" check="1 = 1" information="ma_cqcnpd$zcdmcqcnpd.ten_cqcnpd%l" new="Default"/>
    </field>
    <field name="ten_noi_cap%l" readOnly="true" external="true"  defaultValue="''" >
      <header v="" e=""></header>
    </field>
    <field name="gia_han" type="Boolean" >
      <header v="Gia hạn thiết kế cơ sở" e="Extend the basic design"/>
      <clientScript><![CDATA[onchange="onChange$Voucher$GiaHan(this);"]]></clientScript>
      <items style="CheckBox"/>
    </field>
    <field name="kt_sl" type="Boolean" >
      <header v="Không kiểm tra số lượng" e="Party Member"/>
      <clientScript><![CDATA[onchange="onChange$Voucher$KiemTra(this);"]]></clientScript>
      <items style="CheckBox"/>
    </field>
    <field name="canh_bao_yn" type="Boolean" >
      <header v="Cảnh báo" e="Warning"/>
      <items style="CheckBox"/>
    </field>
    <field name="theo_nam" type="Boolean" >
      <header v="Giấy phép theo năm" e="Party Member"/>
      <items style="CheckBox"/>
    </field>
    <field name="ong_ba">
      <header v="Người nhận" e="Recipient"></header>
    </field>

    <field name="ma_gd" defaultValue="2">
      <header v="Mã giao dịch" e="Transaction Code"></header>
      <items style="AutoComplete" controller="TransactionCode" reference="ten_gd%l" key="ma_ct = @@id and status = '1'" check="ma_ct = @@id" information="ma_gd$dmmagd.ten_gd%l" row="1"/>
      <clientScript><![CDATA[onchange="onChange$Voucher$Transaction(this);"]]></clientScript>
    </field>
    <field name="ten_gd%l" readOnly="true" external="true" defaultValue="''">
      <header v="" e=""></header>
    </field>
    <field name="loai_ct" hidden="true" width="0"  filterSource="Vacant">
      <header v="" e=""></header>
    </field>

    &XMLVoucherBookAndNumberFields;

    <field name="so_ct" dataFormatString="@upperCaseFormat" align="right">
      <header v="Số chứng từ" e="Voucher Number"></header>
      <items style="Mask"/>
    </field>

    <field name="ngay_lct" type="DateTime" dataFormatString="@datetimeFormat" allowNulls="false">
      <header v="Ngày lập" e="Invoice Date"></header>
      <clientScript><![CDATA[onchange="onChange$VoucherDate(this);"]]></clientScript>
    </field>
    <field name="ngay_ct" type="DateTime" dataFormatString="@datetimeFormat" hidden="true">
      <header v="" e=""></header>
    </field>

    <field name="status" inactivate="true" clientDefault="0">
      <header v="Trạng thái" e="Status"></header>
      <items style="DropDownList">
        <item value="0">
          <text v="0. Lập chứng từ" e="0. No Action"/>
        </item>
        <item value="1">
          <text v="1. Giao hàng" e="1. Deliver"/>
        </item>
        &VoucherLogStatusField;
      </items>
    </field>

    <field name="dtk2" external="true" clientDefault="0" defaultValue="0" rows="180" filterSource="Tidy" categoryIndex="1">
      <header v="" e=""></header>
      <label v="Chi tiết" e="Detail"></label >
      <items style="Grid" controller="TK2Detail" row="1">
        <item value="ForeignKey">
          <text v ="String: stt_rec, stt_rec" e="String: stt_rec, stt_rec"></text>
        </item>
      </items>
    </field>

    <field name="t_so_luong" type="Decimal" dataFormatString="@quantityInputFormat" clientDefault="0" disabled="true" categoryIndex="-1">
      <header v="Tổng cộng" e="Total"></header>
      <items style="Numeric"/>
    </field>

    <field name="ten_kh_null"  external="true" clientDefault="Default" defaultValue="''" categoryIndex="2">
      <header v="Tên khách hàng" e="Name Cust"></header>
    </field>
    <field name="dc_kh_null" external="true" clientDefault="Default" defaultValue="''" categoryIndex="2">
      <header v="Địa chỉ" e="Addr"></header>
    </field>
    <field name="dai_dien_null" external="true" clientDefault="Default" defaultValue="''" categoryIndex="2">
      <header v="Đại diện" e="ĐD"></header>
    </field>
    <field name="chuc_vu_null" external="true" clientDefault="Default" defaultValue="''" categoryIndex="2">
      <header v="Chức vụ" e="CV"></header>
    </field>
    <field name="dien_thoai_null"  external="true" clientDefault="Default" defaultValue="''" categoryIndex="2">
      <header v="Điện thoại" e="DT"></header>
    </field>
    <field name="fax_null"  external="true" clientDefault="Default" defaultValue="''" categoryIndex="2">
      <header v="Fax" e="FAX"></header>
    </field>


    <field name="tdx" external="true" readOnly="true" defaultValue="''" categoryIndex="9">
      <header v="Tọa độ X" e="Tọa độ X"></header>
    </field>
    <field name="td_x1" type="Decimal" dataFormatString="### ### ### ##0.000" categoryIndex="9">
      <header v="X1" e="X1"></header>
      <items style="Numeric"/>
    </field>
    <field name="td_x2" type="Decimal" dataFormatString="### ### ### ##0.000" categoryIndex="9">
      <header v="X2" e="Total"></header>
      <items style="Numeric"/>
    </field>

    <field name="tdy" external="true" readOnly="true" defaultValue="''" categoryIndex="9">
      <header v="Tọa độ Y" e="Tọa độ Y"></header>
    </field>
    <field name="td_y1" type="Decimal" dataFormatString="### ### ### ##0.000" categoryIndex="9">
      <header v="Y1" e="Total"></header>
      <items style="Numeric"/>
    </field>
    <field name="td_y2" type="Decimal" dataFormatString="### ### ### ##0.000" categoryIndex="9">
      <header v="Y2" e="Total"></header>
      <items style="Numeric"/>
    </field>

    <field name="tdz" external="true" readOnly="true" defaultValue="''" categoryIndex="9">
      <header v="Cao độ Z" e="Cao độ Z"></header>
    </field>
    <field name="td_z1" type="Decimal" dataFormatString="### ### ### ##0.000" categoryIndex="9">
      <header v="Z1" e="Total"></header>
      <clientScript><![CDATA[onchange="onChange$Voucher$TDZ(this);"]]></clientScript>
      <items style="Numeric"/>
    </field>
    <field name="td_z2" type="Decimal" dataFormatString="### ### ### ##0.000" categoryIndex="9">
      <header v="Z2" e="Total"></header>
      <items style="Numeric"/>
    </field>

    &ListField;

    <field name="cookie" external="true" hidden="true" readOnly="true" defaultValue="''" allowContain="true">
      <header v="" e=""></header>
    </field>
  </fields>

  <views>
    <view id="Dir" height="250" anchor="15" split="15">
      <item value="140, 100, 40, 25, 100, 50, 25, 100, 50, 25, 42, 8, 100, 0, 0, 0"/>
      <item value="11-1101101100000: [so_gpsd].Label, [so_gpsd],[gia_han],[gia_han].Label,[kt_sl],[kt_sl].Label,[theo_nam],[theo_nam].Label "/>
      <item value="---11-----------: [canh_bao_yn],[canh_bao_yn].Label"/>
      <item value="11-1000000000000: [ma_kh].Label, [ma_kh],[ten_kh%l]"/>
      <item value="11000-----------: [dien_giai].Label, [dien_giai]"/>
      <item value="11-10000000000---11: [ma_vv].Label, [ma_vv],[ten_vv%l],[ma_gd],[status]"/>
      <item value="11--------------: [ngay_ky].Label, [ngay_ky]"/>
      <item value="11--------------1: [fcode3].Label,[fcode3],[stt_rec]"/>
      <item value="11101101-------111: [so_thang].Label, [so_thang], [ngay_hsd1].Label,[ngay_hsd1],[ngay_hsd2].Label,[ngay_hsd2],[ong_ba],[so_ct],[ngay_lct]"/>
      <item value="11-1000000000111: [ub_nd].Label, [ub_nd],[ten_noi_cap%l], [ngay_ct], [stt_rec], [ma_nk]"/>

      <item value="1: [dtk2]"/>

      <item value="100-1001: [tdx].Label, [tdz].Label, [tdz]"/>
      <item value="-11--11: [td_x1].Label, [td_x1], [td_z1].Label, [td_z1]"/>
      <item value="-11--11: [td_x2].Label, [td_x2], [td_z2].Label, [td_z2]"/>
      <item value="1000000: [tdy].Label"/>
      <item value="-11----: [td_y1].Label, [td_y1]"/>
      <item value="-11----: [td_y2].Label, [td_y2]"/>

      <item value="1100000000000: [ten_kh_null].Label, [ten_kh_null]"/>
      <item value="1100000000000: [dc_kh_null].Label, [dc_kh_null]"/>
      <item value="111010-------: [dai_dien_null].Label, [dai_dien_null],[dien_thoai_null].Label, [dien_thoai_null]"/>
      <item value="111010------: [chuc_vu_null].Label, [chuc_vu_null],[fax_null].Label, [fax_null]"/>

      &ListView;

      <item value="------101011: [t_so_luong].Label, [t_so_luong], [ma_dvcs], [cookie]"/>

      <categories>
        <category index="1" columns="820" anchor="1">
          <header v="Chi tiết" e="Detail"/>
        </category>
        <category index="2" columns="140, 100, 40, 25, 100, 50, 25, 100, 50, 25, 42, 8, 100, 0, 0, 0" anchor="15">
          <header v="Thông tin khách hàng" e="Detail"/>
        </category>

        &ListCategory;

        <category index="9" columns="50, 50, 100, 100, 50, 50, 100, 0" anchor="7" split="7">
          <header v="Khác" e="Include"/>
        </category>

        <category index="-1" columns="100, 100, 100, 37, 200, 8, 58, 42, 8, 100, 0, 0" anchor="5">
          <header v="" e=""/>
        </category>
      </categories>
    </view>
  </views>

  <commands>
    &XMLWhenVoucherInit;
    &ListShowing;

    <command event="Loading">
      <text>
        &CommandWhenVoucherLoading;
        &CommandGetVoucherNumber;
        <![CDATA[
declare @message nvarchar(4000)
]]>&CommandQueryVoucherNumber;<![CDATA[ + ';active$Voucher$(this);']]>
        &CommandCheckVoucherHandleBeforeEdit;
        &CommandWhenVoucherBeforeEdit;
        <![CDATA[
select @message as message
return
]]>
      </text>
    </command>

    <command event="Scattering">
      <text>
        &CommandGetVoucherNumber;
        <![CDATA[
declare @message nvarchar(4000)
]]>&CommandScatterVoucherNumber;<![CDATA[ + ';scatter$Voucher$(this);']]>
        &CommandCheckVoucherHandleBeforeEdit;
        &CommandWhenVoucherBeforeEdit;
        <![CDATA[
select @message as message
return
]]>
      </text>
    </command>

    &XMLWhenVoucherNavigating;

    <command event="InitExternalFields">
      <text>
        <![CDATA[
declare @voucherBook varchar(32), @currentNumber varchar(32), @minNumber varchar(32), @maxNumber varchar(32), @cookie varchar(32), @CusCode varchar(32)
select @voucherBook = rtrim(ma_nk), @cookie = convert(varchar(19), datetime2, 121), @CusCode = ma_kh from @@prime$partition$current where stt_rec = @stt_rec

if @@action = 'New' begin
  declare @currentDate smalldatetime
  select @currentDate = convert(char(8), getdate(), 112)
  if @voucherBook <> '' begin
    if not exists (select 1 from v20dmnk where status = 1 and ma_nk = @voucherBook and so_ct0 <> so_ct2 and (ma_dvcs = @@unit or ma_dvcs = '') and (@currentDate between ngay_hl_tu and ngay_hl_den or ((ngay_hl_tu is null and @currentDate <= ngay_hl_den) or (ngay_hl_den is null and ngay_hl_tu <= @currentDate)) or (ngay_hl_tu is null and ngay_hl_den is null)) and ma_nk in (select ma_nk from v20dmctnk where ma_ct = @@id and (lstuser = '' or charindex(rtrim(@@userName) + ',', replace(lstuser, ' ', '') + ',') > 0))) begin
      select @voucherBook = ''
    end
  end
end

if @voucherBook = '' select @currentNumber = '', @minNumber = '', @maxNumber = ''
  else select @currentNumber = rtrim(ltrim(so_ct0)), @minNumber = rtrim(ltrim(so_ct1)), @maxNumber = rtrim(ltrim(so_ct2)) from v20dmnk where ma_nk = @voucherBook

-- Get thông tin khách hàng
declare @CusName nvarchar(128), @CusAddress nvarchar(128), @CusDaiDien nvarchar(128), @CusPhone nvarchar(50), @CusChucVu nvarchar(50), @CusFax nvarchar(50)
if exists( select 1 from dmkh where ma_kh = @CusCode)
	select @CusName = ten_kh, @CusAddress = dia_chi, @CusDaiDien = dai_dien, @CusPhone = dien_thoai, @CusChucVu = chuc_vu, @CusFax = fax from dmkh where ma_kh = @CusCode

select @voucherBook as ma_nk, @currentNumber as so_ct0$, @minNumber as so_ct1$, @maxNumber as so_ct2$, @cookie as cookie
	, @CusName as ten_kh_null, @CusAddress as dc_kh_null, @CusDaiDien as dai_dien_null, @CusPhone as dien_thoai_null, @CusChucVu as chuc_vu_null, @CusFax as fax_null
return
]]>
      </text>
    </command>

    &XMLWhenVoucherClosing;

    <command event="Copying">
      <text>
        <![CDATA[
if not exists(select 1 from @@master where stt_rec = @stt_rec and ma_dvcs = @@unit) begin
	select case when @@language = 'V' then N'Đơn vị hiện thời không phải đơn vị ngầm định, không thể sao chép chứng từ được.' else N'Current unit is not default, data copy is not allowed.' end as message
	return
end
select '' as message, 'when$VoucherCopying(this)' as script
]]>
      </text>
    </command>



    <command event="Inserting">
      <text>
        &CommandCheckVoucherNumberDeclare;
        &CommandCheckLockedDate;
        &CommandCheckVoucherHandleBeforeSave;
        &CommandCheckVoucherNumberExecute;
        &CommandGetIdentityNumber;

        <![CDATA[
select @ma_dvcs = @@unit, @ma_ct = @@id, @ngay_ct = @ngay_lct, @ma_nt = '', @ty_gia = 1, @datetime0 = getdate(), @datetime2 = getdate(), @user_id0 = @@userID, @user_id2 = @@userID
]]>
        &CheckSoGPInserting;
        <![CDATA[
update @dtk2 set stt_rec = @stt_rec, ma_ct = @ma_ct, ngay_ct = @ngay_ct, so_ct = @so_ct
]]>
      </text>
    </command>

    <command event="Inserted">
      <text>
        <![CDATA[
insert into dtk2$$partition$current select * from @dtk2
]]>
        &AfterUpdate;
        <![CDATA[
exec AI_ERP$App$IncreaseVoucherNumber @ma_nk, @@id, @so_ct
]]>
        &ListDeclare;
        &ListWarning;
        &ListCommand;
        &ListQuery;<![CDATA[, @stt_rec as stt_rec, @@unit as ma_dvcs 
		else select @stt_rec as stt_rec, @@unit as ma_dvcs
]]>
        <![CDATA[
delete ctk2$000000 where status = 'L'
]]>
      </text>
    </command>

    <command event="Updating">
      <text>
        &CheckSoGPUpdating;
        &CommandCheckVoucherNumberDeclare;
        &CommandRecordHasBeenChanged;
        &CommandCheckLockedDate;
        &CommandCheckVoucherHandleBeforeSave;
        &CommandCheckVoucherNumberExecute;
        <![CDATA[
#IF '$partition$current' <> '$partition$previous' #THEN
	insert into @@prime$partition$current select * from @@prime$partition$previous where stt_rec = @stt_rec
	#IF $dtk2.NewValue = $dtk2.OldValue #THEN
		insert into dtk2$$partition$current select * from dtk2$$partition$previous where stt_rec = @stt_rec
		delete dtk2$$partition$previous where stt_rec = @stt_rec
	#END
	delete @@prime$partition$previous where stt_rec = @stt_rec
	delete @@inquiry$partition$previous where stt_rec = @stt_rec
#END

#IF $dtk2.NewValue = $dtk2.OldValue #THEN
	update dtk2$$partition$current set stt_rec = @stt_rec, ngay_ct = @ngay_ct, so_ct = @so_ct, ma_ct = @@id where stt_rec = @stt_rec
#ELSE
	update @dtk2 set stt_rec = @stt_rec, ngay_ct = @ngay_ct, so_ct = @so_ct, ma_ct = @@id
	delete dtk2$$partition$previous where stt_rec = @stt_rec
#END
]]>
      </text>
    </command>

    <command event="Updated">
      <text>
        <![CDATA[
#IF $dtk2.NewValue <> $dtk2.OldValue #THEN
	insert into dtk2$$partition$current select * from @dtk2
#END
update @@prime$partition$current set ma_nt = '', ngay_ct = @ngay_lct, ty_gia = 1, datetime2 = getdate(), user_id2 = @@userID where stt_rec = @stt_rec
]]>
        &AfterUpdate;
        &EndUpdatedVoucherNumber;
        &ListDeclare;
        &ListWarning;
        &ListCommand;
        &ListQuery;
        <![CDATA[
delete ctk2$000000 where status = 'L'
]]>
      </text>
    </command>

    <command event="Deleting">
      <text>
        &CommandCheckVoucherHandleBeforeDelete;
        &CommandWhenVoucherBeforeDelete;
        <![CDATA[
delete @@inquiry$partition$current where stt_rec = @stt_rec]]>&VoucherLogKey;<![CDATA[
delete dtk2$$partition$current where stt_rec = @stt_rec]]>&VoucherLogKey;<![CDATA[
delete @@master where stt_rec = @stt_rec]]>&VoucherLogKey;<![CDATA[
]]>
        &VoucherLogUpdateStatus;
        &VoucherLogBeginComment;
      </text>
    </command>

    <command event="Deleted">
      <text>
        &VoucherLogEndComment;
        <![CDATA[
declare @invoke nvarchar(4000)
select @invoke = ''
]]>&ListDeleted;<![CDATA[
select @invoke as invoke
]]>
      </text>
    </command>

    <command event="Checking">
      <text>
        <![CDATA[/* <flatten type="Javascript"> */
/*var f = this, id = f.get_id(), v = f._language == 'v', g = f.getItem('dtk2')._controlBehavior, l = g._getColumnOrder('xaction'), t = f.getItemValue('ma_kh'), c = '';
var e1 = (v ? 'Thông tin mã khách của phiếu giao hàng phải giống với hóa đơn hoặc phiếu xuất.' : 'Delivery Note should have same customer information as Sales Invoice or Pick List.');
var e2 = (v ? 'Dữ liệu trong chi tiết chỉ được lấy số liệu từ hóa đơn hoặc phiếu xuất.' : 'Data in grid form must be extracted from Sales Invoice or Pick List.');
for (var i = 1; i <= g._rowCount; i++) {
	v = $func.trim(g._getItemValue(i, l));
	if (v) {
		var u = g._getItem(i, 1)._customerIdentity;
		if (!u) u = (f._action == 'Edit') ? f._customerIdentity : t;
		if (t != u) {
			$func.hideWait(id);
			$message.show(e1, String.format('$find(\'{0}\').getItem(\'ma_kh\').focus()', id));
			f._checked = false;
			break;
		}
		if (f._checked) {
			if (!c) c = v;
			if (c != v) {
				g._errorWarningObject = g._getItem(1, g._getColumnOrder('ma_vt'));
				$message.show(e2, String.format('$find(\'{0}\').focus(\'r67\');$find(\'{1}\')._errorWarningObject.focus()', id, g.get_id()));
				f._checked = false;
				break;
			}
		}
	}
}*/
/* </flatten> */
]]>
        &ListChecking;
      </text>
    </command>
  </commands>

  <script>
    <text>
      &ScriptVoucherInit;
      &ScriptVoucherNumber;
      <![CDATA[
		var form;
function init$Voucher$(f) {initialize(f, 'ong_ba', 'ma_gd', 'loai_ct', 'status');}
function active$Voucher$(f) {
	form = f;
	var q = f.getItem('fcode3')
	objectBehavior$Voucher$Number.create(f, 'so_ct', 'ma_nk', 'ngay_lct', 'ma_dvcs');
	f.add_onResponseComplete(on$Voucher$ResponseComplete);
	f.add_commandEvent(on$Voucher$ExecuteCommand);
	f._tabContainer.add_activeTabChanged(onChange$Voucher$Tab);
	f._tabContainer._loaded = true;
	set$Voucher$DefaultValue(f);
	$get('ctl00_AI_ERP_MainReport_dirExtender_ToolbarButton_Print').style.display = 'none';
	if(f._action == 'New' || f._action == 'Edit') onChange$Voucher$GiaHan(q);

]]>&VoucherLogHandleStatus;<![CDATA[
	]]>&ListCreate;<![CDATA[
}
function scatter$Voucher$(f) {
	f._voucherNumberBehavior.setFormLayout();
	set$Voucher$DefaultValue(f);
	form = f;
	var q = f.getItem('fcode3')
	if(f._action == 'New' || f._action == 'Edit') onChange$Voucher$GiaHan(q);
	
	]]>&VoucherLogHandleStatus;<![CDATA[
}
function close$Voucher$(f) {
	try {f.remove_commandEvent(on$Voucher$ExecuteCommand);} catch (ex) {}
	try {f.remove_onResponseComplete(on$Voucher$ResponseComplete);} catch (ex) {}
	objectBehavior$Voucher$Number.dispose(f);
	if (f._tabContainer) try {f._tabContainer.remove_activeTabChanged(onChange$Voucher$Tab);} catch (ex) {}
	]]>&ListDispose;<![CDATA[
}
function on$Voucher$ExecuteCommand(sender, e) {
	var action = e.type.Action, f = sender, g = f.getItem('dtk2')._controlBehavior;
	switch (action) {
		case 'Explore':
			f.request('KhachHang', 'KhachHang', ['ma_kh']);
			break;
		 case 'Navigator':
			f.request('KhachHang', 'KhachHang', ['ma_kh']);
			break;
		case 'Load':
			f.request('KhachHang', 'KhachHang', ['ma_kh']);
			var o = form.getItem('kt_sl');
			var t = form.getItemValue('kt_sl');
			if(t) onChange$Voucher$KiemTra(o);
			break;
		case 'Gather':
			g.setSequenceNumber('line_nbr');
			g.setContinuance('stt_rec0');
			break;
		case 'Shown':
			$get('ctl00_AI_ERP_MainReport_dirExtender_ToolbarButton_Print').style.display = 'none';
			]]>&ListShown;<![CDATA[
			break;
		case 'Explore':
			]]>&VoucherLogHandleStatusExplore;<![CDATA[
			break;
		default:
			break;
	}
}
function onChange$Voucher$Tab(sender, e) {
	sender.parentForm.focusWhenTabChanged(['dtk2', null]);
	var o = form.getItem('kt_sl');
	var t = form.getItemValue('kt_sl');
	if(t) onChange$Voucher$KiemTra(o);
}
/* <flatten type="Javascript"> */
function onChange$Voucher$Customer(o) {
	o.parentForm.setItemValue('ma_vv','');
	o.parentForm.setItemValue('ten_vv','');
	o.parentForm.setReferenceKeyFilter('ma_vv');
	o.parentForm.request('KhachHang', 'KhachHang', ['ma_kh'], o);
	o.parentForm.setReferenceKeyFilter('fcode3');
}

function onChange$Voucher$KiemTra(o) {
	var f = o.parentForm; g = f.getItem('dtk2')._controlBehavior;
	var t = f.getItemValue('kt_sl');
	if(t){
		DeleteAllGridbyCus(g);
		f.setItemValue('t_so_luong', 0);
		$get('ctl00_AI_ERP_MainReport_dirExtender_Tabs_Panel1').style.display = 'none';
	}else{
		f.focus('dtk2');
		$get('ctl00_AI_ERP_MainReport_dirExtender_Tabs_Panel1').style.display = 'block';
	}
}

function DeleteAllGridbyCus(g){
	var x = '', f = g.get_element().parentForm;
	if(f._action == 'New' || f._action == 'Edit'){
		$get(String.format('{0}_gridTable',g._id)).childNodes[0].innerHTML="";
		g._rowCount = 0;
		g._activeRow = -1;
		g._activeCell = null;
		g._activeColumn = -1;
	}
	g._appendRow(null,true)
}
function onChange$Voucher$GiaHan(o) {
var f = o.parentForm; var q = f.getItem('fcode3'), t = f.getItemValue('gia_han');
if(t){
	q.field.AllowNulls = false;
	f._setReadOnly(q, false); 
}
else{
	q.field.AllowNulls = true;
	f._setReadOnly(q, true);
	f.setItemValue('fcode3', '');
	f.setItemValue('ten_fcode3', '');
}
}
function onChange$Voucher$Ngay_ky1(o) {
	var f = o.parentForm;
	f.request('Ngay_ky1', 'Ngay_ky1', ['ngay_hsd1','so_thang']);
}


function onChange$Voucher$Ngay_ky(o) {
	var f = o.parentForm; f.setItemValue('ngay_hsd1', f.getItemValue('ngay_ky'));
	f.request('Ngay_ky1', 'Ngay_ky1', ['ngay_hsd1','so_thang']);
		
}

function onChange$Voucher$TDZ(o) {
	 o.parentForm.setItemValue('td_z2', o.parentForm.getItemValue('td_z1'));
}
function onChange$VoucherDate(o) {var f = o.parentForm; f.setItemValue('ngay_ct', f.getItemValue('ngay_lct'));}
/* </flatten> */
function on$Voucher$ResponseComplete(sender, e) {
	var f = e.object, context = e.type.Context, result = e.type.Result;
	switch (context) {
		case 'Loading':]]>
      &VoucherNumberLoading;<![CDATA[
			break;
		case 'Scattering':]]>
      &VoucherNumberScattering;<![CDATA[
			]]>&ListScattering;<![CDATA[
			]]>&PostScattering;<![CDATA[
			break;
]]>
      &VoucherNumberReading;
      <![CDATA[
		case 'Transaction':
			f.setItemValue('loai_ct', result[0].Value);
			break;
		case 'Ngay_ky1':
			f.setItemValue('ngay_hsd2', result[0].Value);
			break;  
		case 'KhachHang':
			f.setItemValue('ten_kh_null', result[0].Value);
			f.setItemValue('dc_kh_null', result[1].Value);
			f.setItemValue('dai_dien_null', result[2].Value);
			f.setItemValue('dien_thoai_null', result[3].Value);
			f.setItemValue('chuc_vu_null', result[4].Value);
			f.setItemValue('fax_null', result[5].Value);
		break;  
		case 'Navigating':
			]]>&ListRefresh;<![CDATA[
			]]>&PostRefresh;<![CDATA[
			break;
		]]>&ListResponseTicket;<![CDATA[
		default:
			break;
	}
}
/* <flatten type="Javascript"> */
function set$Voucher$DefaultValue(f) {
	if (f._action == 'New') {
		var d = new Date();
		f.setItemValue('ngay_lct', d);
		f.setItemValue('ngay_ct', d);
		if(f.getItemValue('ngay_ky') == null) if(f.setItemValue('ngay_ky', d));
		if(f.getItemValue('ngay_hsd1') == null) f.setItemValue('ngay_hsd1', d);
		if(f.getItemValue('ngay_hsd2') == null) f.setItemValue('ngay_hsd2', d);
	}
	if (f._action == 'Edit') f._customerIdentity = f.getItemValue('ma_kh');
}
function onChange$Voucher$Transaction(o) {o.parentForm.request('Transaction', 'Transaction', ['ma_gd'], o);}

function when$VoucherCopying(f) {
	f.setReferenceKeyFilter('ma_vv');
	f.setReferenceKeyFilter('fcode3');
}
/* </flatten> */]]>
      &ListScript;
      &PostScript;
    </text>
  </script>

  <response>
    &XMLGetContactInfo;

    <action id="Reading">
      <text>
        &CommandSetVoucherNumber;
      </text>
    </action>

    <action id="Transaction">
      <text>
        <![CDATA[
select rtrim(loai_ct) as loai_ct from dmmagd where ma_ct = 'HCE' and ma_gd = @ma_gd
return
]]>
      </text>
    </action>
    <action id="KhachHang">
      <text>
        <![CDATA[
if exists( select 1 from dmkh where ma_kh = @ma_kh)
	select ten_kh,dia_chi,dai_dien,dien_thoai,chuc_vu,fax from dmkh where ma_kh = @ma_kh
]]>
      </text>
    </action>
    <action id="Ngay_ky1">
      <text>
        <![CDATA[
if(@ngay_hsd1 is not null)
	select DATEADD(month, @so_thang, @ngay_hsd1)
]]>
      </text>
    </action>
    &XMLGetVoucherNumber;
    &ListTicket;
  </response>
</dir>