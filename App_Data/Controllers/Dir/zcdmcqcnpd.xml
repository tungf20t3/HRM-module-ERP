<?xml version="1.0" encoding="utf-8"?>

<!DOCTYPE dir [
  <!ENTITY TransferID "zcdmcqcnpd">
]>

<dir table="zcdmcqcnpd" code="ma_cqcnpd" order="ma_cqcnpd" xmlns="urn:schemas-ai-erp:data-dir">
  <title v="danh mục cơ quan chức năng phê duyệt" e="List of authorized agency approvals"></title>
  <fields>
    <field name="ma_cqcnpd" isPrimaryKey="true" allowNulls ="false">
      <header v="Mã cơ quan" e="ID"></header>
    </field>
    <field name="ten_cqcnpd">
      <header v="Tên cơ quan chức năng phê duyệt" e="Name"></header>
    </field>
    <field name="status" dataFormatString="0, 1" clientDefault="1" align="right" inactivate="true">
      <header v="Trạng thái" e="Status"></header>
      <footer v="1 - Còn sử dụng, 0 - Không còn sử dụng" e="1 - Active, 0 - Inactive"></footer>
      <items style="Mask"/>
    </field>
  </fields>

  <views>
    <view id="Dir">
      <item value="200, 40, 50, 150, 50 "/>
      <item value="110: [ma_cqcnpd].Label, [ma_cqcnpd]"/>
      <item value="1100: [ten_cqcnpd].Label, [ten_cqcnpd]"/>
      <item value="111000: [status].Label, [status], [status].Description"/>
    </view>
  </views>

  <commands>
    <command event="Loading">
      <text>
        <![CDATA[
select 'active$]]>&TransferID;<![CDATA[$Form(this);' as message
return
]]>
      </text>
    </command>

    <command event="Closing">
      <text>
        <![CDATA[
select 'close$]]>&TransferID;<![CDATA[$Form(this);' as message
return
]]>
      </text>
    </command>

    <command event="Declare">
      <text>
        <![CDATA[
declare @$exist nvarchar(512), @$recordHasBeenChanged nvarchar(512)
select @$exist = case when @@language = 'v' then N'Mã cơ quan <span class="Highlight">%s</span> đã có hoặc lồng nhau trong danh mục cơ quan chức năng phê duyệt.' else N'The code <span class="Highlight">%s</span> already included or nested in the list of authorized agency approvals.' end
select @$recordHasBeenChanged = case when @@language = 'v' then N'Mã cơ quan <span class="Highlight">%s</span> đã được sửa hoặc xóa bởi người sử dụng khác.' else N'The code <span class="Highlight">%s</span> has been modified or deleted by another user.' end
]]>
      </text>
    </command>

    <command event="Inserting">
      <text>
      <![CDATA[
      IF EXISTS(select 1 from @@table WHERE ma_cqcnpd = @ma_cqcnpd)
      BEGIN
        select 'ma_cqcnpd' AS field, replace(@$exist, '%s', rtrim(@ma_cqcnpd)) AS message
        return
      END      
          
      select @datetime0 = getdate(), @datetime2 = getdate(), @user_id0 = @@userID, @user_id2 = @@userID  
      ]]>
      </text>
    </command>

    <command event="Updating">
      <text>
      <![CDATA[
      IF NOT EXISTS(select * from @@table WHERE ma_cqcnpd = $ma_cqcnpd.OldValue) 
      BEGIN
        select 'ma_cqcnpd' AS field, replace(@$recordHasBeenChanged, '%s', rtrim($ma_cqcnpd.OldValue)) AS message
        return
      END
        
      IF @ma_cqcnpd <> $ma_cqcnpd.OldValue 
      BEGIN
        IF EXISTS(select 1 from @@table WHERE ma_cqcnpd = @ma_cqcnpd and ma_cqcnpd <> $ma_cqcnpd.OldValue) 
        BEGIN
          select 'ma_cqcnpd' AS field, replace(@$exist, '%s', rtrim(@ma_cqcnpd)) AS message
          return
        END
      END
      ]]>
      </text>
    </command>

    <command event="Updated">
      <text>
      <![CDATA[
      UPDATE @@table SET datetime2 = getdate(), user_id2 = @@userID WHERE ma_cqcnpd = @ma_cqcnpd
      ]]>
      </text>
    </command>

    <command event="Deleting">
      <text>
        <![CDATA[
          delete from @@table where ma_cqcnpd = @ma_cqcnpd
        ]]>
      </text>
    </command>
  </commands>

  <script>
    <text>
      <![CDATA[
function active$]]>&TransferID;<![CDATA[$Form(f) { f.add_onResponseComplete(on$]]>&TransferID;<![CDATA[$Form$ResponseComplete); }
function close$]]>&TransferID;<![CDATA[$Form(f) { try {f.remove_onResponseComplete(on$]]>&TransferID;<![CDATA[$Form$ResponseComplete)} catch (ex) {} }
function on$]]>&TransferID;<![CDATA[$Form$ResponseComplete(sender, e) {
  var f = e.object, context = e.type.Context, result = e.type.Result;
  switch (context) {
    default:
      break;
  }
}
]]>
      <!--&ScriptIrregular;-->
    </text>
  </script>
</dir>